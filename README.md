# 🛒 توثيق API الدفع وتسجيل الطلبات (Stripe Checkout)

---

## 📦 نقاط النهاية (Endpoints)

---

### ✅ 1. إنشاء جلسة دفع وتسجيل الطلب

`POST /api/stripe/create-checkout-session`

---

### 🔧 البيانات المطلوبة (Body):

```json
{
  "cartItems": [
    {
      "productId": "معرّف المنتج من قاعدة البيانات",
      "quantity": 2
    },
    {
      "productId": "معرّف منتج آخر",
      "quantity": 1
    }
  ],
  "userId": "معرّف المستخدم"
}
```

---

### 🔄 الرد (Response):

```json
{
  "url": "رابط الدفع من Stripe"
}
```

---

### 📖 شرح الوظيفة:

* السيرفر يتحقق من المنتجات والأسعار.
* يتم تسجيل الطلب في قاعدة البيانات بحالة "في انتظار الدفع".
* يتم إنشاء جلسة دفع من خلال Stripe.
* يتم إرجاع رابط الدفع للفرونت.

---

---

### ✅ 2. جلب بيانات جلسة الدفع بعد الرجوع من Stripe

`GET /api/stripe/session/:sessionId`

---

### 📥 المطلوب:

* تبعت مع الطلب `sessionId` اللي Stripe بيرجعه في رابط النجاح بعد إتمام الدفع.

---

### 🔄 الرد (Response):

```json
{
  "amountPaid": 2000,
  "currency": "usd",
  "paymentStatus": "paid",
  "customerName": "اسم العميل",
  "customerEmail": "البريد الإلكتروني",
  "orderId": "معرّف الطلب في قاعدة البيانات"
}
```

---

### 📖 شرح الوظيفة:

* يتم استرجاع بيانات جلسة الدفع من Stripe.
* تُعرض معلومات الدفع للعميل مثل المبلغ، حالة الدفع، بيانات العميل، ورقم الطلب.

---

---

## 🛡️ ملاحظات الأمان:

✔️ لا يجب على الفرونت إرسال أسعار المنتجات، السيرفر هو المسؤول عن التحقق منها.

✔️ الطلب يُسجل أولاً في قاعدة البيانات، ويُربط بجلسة Stripe تلقائياً عبر الـ `metadata`.

✔️ الأسعار تُحسب بالكامل في الباكند لحماية النظام من التلاعب.

---

---

## 🧑‍💻 مثال عملي للفرونت (باستخدام Fetch):

```js
const res = await fetch('/api/stripe/create-checkout-session', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    cartItems: [
      { productId: "معرّف منتج", quantity: 2 },
      { productId: "معرّف منتج آخر", quantity: 1 }
    ],
    userId: "معرّف المستخدم"
  })
});

const data = await res.json();
window.location.href = data.url;
```

---

---

## ⚠️ تنبيهات إضافية:

* يجب التقاط `session_id` من رابط النجاح بعد الدفع، واستخدامه لجلب تفاصيل الجلسة.
* لا يجب الاعتماد على بيانات الأسعار أو المبلغ من